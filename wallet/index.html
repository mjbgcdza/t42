<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallet Dashboard-T42</title>
    <meta name="description" content="wallet for LIFF App" />
    <meta name="author" content="T42" />
    <meta property="og:title" content="wallet-T42-thailand" />
    <meta property="og:description" content="wallet for LIFF App" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://lh3.googleusercontent.com/d/1jf9N9aySYkutVo7pf5prE5jXzkE7btbZ" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://bit.ly/fontiton5" type="text/css" charset="utf-8" />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Sarabun:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'line_seed_sans_th';
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe, #dbeafe);
        }

        .card {
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .transaction-list::-webkit-scrollbar {
            width: 4px;
        }

        .transaction-list::-webkit-scrollbar-thumb {
            background-color: #94a3b8;
            border-radius: 20px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fadeInUp {
            animation: fadeInUp 0.5s ease-out forwards;
        }

        .swal2-popup .swal2-styled.swal2-confirm {
            background: linear-gradient(to right, #3b82f6, #60a5fa) !important;
        }

        .swal-custom-form {
            text-align: left;
        }

        .swal-custom-form label {
            display: block;
            margin-bottom: 0.25rem;
            font-weight: 500;
            color: #4b5563;
        }

        .swal-custom-form .swal-input,
        .swal-custom-form .swal-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
        }

        .swal-custom-form .swal-input:focus,
        .swal-custom-form .swal-select:focus {
            outline: none;
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }

        .swal-custom-form .input-with-icon {
            position: relative;
        }

        .swal-custom-form .input-with-icon .icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
        }

        .swal-custom-form .input-with-icon .swal-input {
            padding-left: 2.5rem;
        }
    </style>
</head>

<body class="bg-blue-50 text-gray-800">

    <div id="loading" class="flex justify-center items-center h-screen">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div>
    </div>

    <div id="app" class="hidden opacity-0">
        <header class="p-4 sticky top-0 z-10">
            <div class="container mx-auto flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-blue-700">My Wallet</h1>
                    <p id="displayName" class="text-sm text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="shareBtn" class="text-blue-600 p-2 rounded-full hover:bg-blue-100 transition-colors"
                        title="‡πÅ‡∏ä‡∏£‡πå‡∏ä‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" />
                        </svg>
                    </button>
                    <img id="pictureUrl" class="w-14 h-14 rounded-full border-2 border-white shadow-lg"
                        src="https://img.icons8.com/?size=100&id=K0whyGdxP7Ht&format=png&color=000000"
                        alt="Profile Picture">
                </div>
            </div>
        </header>

        <main class="container mx-auto p-4 space-y-6">
          
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="card p-4 rounded-xl shadow-lg">
                    <h2 class="text-sm font-medium text-gray-500">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)</h2>
                    <p id="summaryIncome" class="text-3xl font-bold text-green-600 mt-1">0.00 ‡∏ö.</p>
                </div>
                <div class="card p-4 rounded-xl shadow-lg">
                    <h2 class="text-sm font-medium text-gray-500">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)</h2>
                    <p id="summaryExpense" class="text-3xl font-bold text-red-600 mt-1">0.00 ‡∏ö.</p>
                </div>
                <div class="card p-4 rounded-xl shadow-lg">
                    <h2 class="text-sm font-medium text-gray-500">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h2>
                    <p id="summaryBalance" class="text-3xl font-bold text-blue-600 mt-1">0.00 ‡∏ö.</p>
                </div>
            </div>

          
            <div class="card p-4 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-gray-700">‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°</h3>
                    <button id="createGroupWalletBtn"
                        class="bg-blue-500 text-white text-sm font-semibold px-3 py-1 rounded-full hover:bg-blue-600 transition-colors">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
                </div>
                <div id="groupWalletList" class="space-y-2">
                    <p class="text-center text-gray-500 py-4">‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏î‡πÜ</p>
                </div>
            </div>

           
            <div class="card p-4 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-gray-700">Saving Challenges</h3>
                    <button id="createChallengeBtn"
                        class="bg-yellow-500 text-white text-sm font-semibold px-3 py-1 rounded-full hover:bg-yellow-600 transition-colors">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤</button>
                </div>
                <div id="challengeList" class="space-y-3">
                    <p class="text-center text-gray-500 py-4">‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° Challenge ‡πÉ‡∏î‡πÜ</p>
                </div>
            </div>

            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card p-4 rounded-xl shadow-lg">
                    <h3 class="font-bold mb-2 text-center text-gray-700">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h3>
                    <div class="chart-container">
                        <canvas id="expenseChart"></canvas>
                    </div>
                </div>
                <div class="card p-4 rounded-xl shadow-lg">
                    <h3 class="font-bold mb-2 text-center text-gray-700">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h3>
                    <div class="chart-container">
                        <canvas id="incomeChart"></canvas>
                    </div>
                </div>
            </div>

          
            <div class="card p-4 rounded-xl shadow-lg">
                <h3 class="font-bold mb-4 text-gray-700">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                <div id="transactionList" class="transaction-list max-h-80 overflow-y-auto">
                    <p class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...</p>
                </div>
            </div>
        </main>

        <button id="addTransactionBtn"
            class="fixed bottom-6 right-6 bg-gradient-to-r from-blue-500 to-indigo-600 text-white w-16 h-16 rounded-full shadow-xl flex items-center justify-center text-4xl hover:from-blue-600 hover:to-indigo-700 transition-all duration-300 transform hover:scale-110">
            <svg class="w-8 h-8 " aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14m-7 7V5"/>
</svg>

        </button>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbwVLoLQ98BeMLQHTp3XYKfN60UQ6VcYxK7yay_WntOV01W0O-bEeDkEZGTM87pgjgOKTQ/exec';
        const LIFF_ID = '2007704777-aBjrMV9V';
        let userData = {};
        let expenseChartInstance = null;
        let incomeChartInstance = null;

        document.addEventListener('DOMContentLoaded', main);

        async function main() {
            try {
                await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true });
                if (!liff.isLoggedIn()) { liff.login({ redirectUri: window.location.href }); return; }
                const profile = await liff.getProfile();
                document.getElementById('displayName').textContent = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ${profile.displayName}`;
                document.getElementById('pictureUrl').src = profile.pictureUrl;

                document.getElementById('createGroupWalletBtn').addEventListener('click', handleCreateGroupWallet);
                document.getElementById('shareBtn').addEventListener('click', handleShare);
                document.getElementById('createChallengeBtn').addEventListener('click', handleCreateChallenge);

                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('action') === 'joinGroup' && urlParams.get('id')) {
                    await handleJoinGroup(urlParams.get('id'));
                } else if (urlParams.get('action') === 'joinChallenge' && urlParams.get('id')) {
                    await handleJoinChallenge(urlParams.get('id'));
                }

                await fetchAndRenderData(profile.userId);
            } catch (error) {
                console.error('LIFF Initialization failed', error);
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LINE ‡πÑ‡∏î‡πâ', 'error');
            }
        }

        async function fetchAndRenderData(userId) {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('app').classList.add('hidden');
            try {
                const response = await fetch(`${API_URL}?action=getDashboardData&userId=${userId}`);
                const result = await response.json();
                if (!response.ok || !result.success) throw new Error(result.error || 'Network response was not ok');

                userData = result.data;

                renderSummary(userData.summary);
                renderWallets(userData.wallets);
                renderCharts(userData.charts);
                renderTransactions(userData.recentTransactions);
                renderChallenges(userData.challenges);

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('app').classList.remove('opacity-0', 'hidden');
                document.getElementById('app').classList.add('animate-fadeInUp');
            } catch (error) {
                console.error('Failed to fetch data:', error);
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ${error.message}`, 'error');
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function animateValue(obj, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const currentNum = progress * (end - start) + start;
                obj.textContent = currentNum.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ‡∏ö.';
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                } else {
                    obj.textContent = end.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ‡∏ö.';
                }
            };
            window.requestAnimationFrame(step);
        }


        function renderSummary(summary) {
            if (!summary) return;
            animateValue(document.getElementById('summaryIncome'), 0, summary.income || 0, 1200);
            animateValue(document.getElementById('summaryExpense'), 0, summary.expense || 0, 1200);
            animateValue(document.getElementById('summaryBalance'), 0, summary.balance || 0, 1200);
        }
        function renderWallets(wallets) {
            const listEl = document.getElementById('groupWalletList');
            if (!wallets || !wallets.group || wallets.group.length === 0) {
                listEl.innerHTML = '<p class="text-center text-gray-500 py-4">‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏î‡πÜ</p>';
                return;
            }
            listEl.innerHTML = wallets.group.map(w => `
                <button data-group-id="${w.groupId}" data-group-name="${w.name}" class="group-wallet-btn w-full text-left p-3 bg-white/50 hover:bg-white/90 rounded-lg shadow transition-all flex justify-between items-center">
                    <p class="font-semibold text-blue-800">${w.name}</p>
                    <span class="text-xs bg-blue-100 text-blue-800 font-semibold px-2 py-1 rounded-full">${w.memberCount || 1} ‡∏Ñ‡∏ô</span>
                </button>
            `).join('');

            document.querySelectorAll('.group-wallet-btn').forEach(btn => {
                btn.addEventListener('click', handleViewGroupWallet);
            });
        }

        function renderCharts(charts) {
            if (!charts) return;
            const chartOptions = {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', labels: { fontFamily: 'Sarabun' } } }
            };

            const expenseCtx = document.getElementById('expenseChart').getContext('2d');
            if (expenseChartInstance) expenseChartInstance.destroy();
            expenseChartInstance = new Chart(expenseCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(charts.expenseByCat || {}),
                    datasets: [{ data: Object.values(charts.expenseByCat || {}), backgroundColor: ['#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e', '#14b8a6'], borderWidth: 0 }]
                },
                options: chartOptions
            });

            const incomeCtx = document.getElementById('incomeChart').getContext('2d');
            if (incomeChartInstance) incomeChartInstance.destroy();
            incomeChartInstance = new Chart(incomeCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(charts.incomeByCat || {}),
                    datasets: [{ data: Object.values(charts.incomeByCat || {}), backgroundColor: ['#16a34a', '#65a30d', '#0284c7', '#4f46e5'], borderWidth: 0 }]
                },
                options: chartOptions
            });
        }

        function renderTransactions(transactions) {
            const listEl = document.getElementById('transactionList');
            if (!transactions || transactions.length === 0) {
                listEl.innerHTML = '<p class="text-center text-gray-500 py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß...</p>';
                return;
            }
            listEl.innerHTML = transactions.map(tx => `
                <div class="flex items-center justify-between py-2 border-b border-gray-200/80 last:border-b-0">
                    <div>
                        <p class="font-semibold truncate text-gray-800">${tx.description}</p>
                        <p class="text-sm text-gray-500">${tx.category} @ ${tx.wallet}</p>
                    </div>
                    <div class="flex items-center">
                        <p class="font-bold mr-2 ${tx.type === '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢' ? 'text-red-600' : 'text-green-600'}">${tx.type === '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢' ? '-' : '+'}${tx.amount.toLocaleString('th-TH')} ‡∏ö.</p>
                        <button class="delete-btn text-gray-400 hover:text-red-500 transition-colors p-1" data-timestamp="${tx.timestamp}">
                            <svg class="w-6 h-6 " aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 7h14m-9 3v8m4-8v8M10 3h4a1 1 0 0 1 1 1v3H9V4a1 1 0 0 1 1-1ZM6 7h12v13a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7Z"/>
</svg>

                        </button>
                    </div>
                </div>
            `).join('');
            document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', handleDeleteTransaction));
        }

        function renderChallenges(challenges) {
            const listEl = document.getElementById('challengeList');
            if (!challenges || challenges.length === 0) {
                listEl.innerHTML = '<p class="text-center text-gray-500 py-4">‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° Challenge ‡πÉ‡∏î‡πÜ</p>';
                return;
            }

            listEl.innerHTML = challenges.map(c => {
                const progressPercent = Math.min((c.myProgress / c.goal) * 100, 100);
                const endDate = new Date(c.endDate).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
                return `
                    <div class="animate-fadeInUp">
                        <div class="flex justify-between items-baseline mb-1">
                            <p class="font-semibold text-gray-700">${c.name}</p>
                            <p class="text-sm text-gray-500">${c.myProgress.toLocaleString()} / ${c.goal.toLocaleString()} ‡∏ö.</p>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="bg-gradient-to-r from-yellow-400 to-orange-500 h-2.5 rounded-full" style="width: ${progressPercent}%"></div>
                        </div>
                        <p class="text-xs text-right text-gray-400 mt-1">‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î: ${endDate}</p>
                    </div>
                `;
            }).join('');
        }

        async function handleCreateGroupWallet() {
            const { value: walletName } = await Swal.fire({
                title: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà', input: 'text', inputLabel: '‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°',
                inputPlaceholder: '‡πÄ‡∏ä‡πà‡∏ô ‡∏ó‡∏£‡∏¥‡∏õ‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô, ‡∏Å‡∏≠‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏≠‡∏≠‡∏ü‡∏ü‡∏¥‡∏®', showCancelButton: true,
                confirmButtonText: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                inputValidator: (value) => !value && '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤'
            });

            if (walletName) {
                Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°...', didOpen: () => Swal.showLoading() });
                try {
                    const profile = await liff.getProfile();
                    const body = new URLSearchParams({ action: 'createGroupWallet', userId: profile.userId, creatorName: profile.displayName, walletName });
                    const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body });
                    const resData = await response.json();
                    if (!resData.success) throw new Error(resData.error);

                    await fetchAndRenderData(profile.userId);
                    Swal.close();
                    await shareGroupInvite(resData.data.groupId, walletName);
                } catch (error) {
                    Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ: ${error.message}`, 'error');
                }
            }
        }

        async function handleJoinGroup(groupId) {
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°...', didOpen: () => Swal.showLoading() });
            try {
                const profile = await liff.getProfile();
                const body = new URLSearchParams({ action: 'joinGroupWallet', userId: profile.userId, displayName: profile.displayName, groupId });
                const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body });
                const resData = await response.json();
                if (!resData.success) throw new Error(resData.error);

                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', resData.data.message, 'success');
                window.history.replaceState({}, document.title, window.location.pathname);
                await fetchAndRenderData(profile.userId);
            } catch (error) {
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÑ‡∏î‡πâ: ${error.message}`, 'error');
            }
        }

        async function shareGroupInvite(groupId, groupName) {
            if (!liff.isApiAvailable('shareTargetPicker')) return;
            const profile = await liff.getProfile();
            const message = {
                type: 'flex', altText: `${profile.displayName} ‡∏ä‡∏ß‡∏ô‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°!`,
                contents: {
                    type: 'bubble', hero: { type: 'image', url: 'https://i.pinimg.com/736x/70/99/26/709926ae5fde92d66801b76bc2272840.jpg', size: 'full', aspectRatio: '20:13', aspectMode: 'cover' },
                    body: {
                        type: 'box', layout: 'vertical', spacing: 'md', contents: [
                            { type: 'text', text: '‡∏Ñ‡∏≥‡πÄ‡∏ä‡∏¥‡∏ç‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°', weight: 'bold', size: 'xl', color: '#3b82f6' },
                            { type: 'text', text: `"${groupName}"`, weight: 'bold', size: 'lg', margin: 'md' },
                            { type: 'text', text: `${profile.displayName} ‡∏ä‡∏ß‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô`, 'wrap': true, 'color': '#666666', 'size': 'sm', 'margin': 'lg' }
                        ]
                    },
                    footer: {
                        type: 'box', layout: 'vertical', spacing: 'sm', contents: [
                            { type: 'button', style: 'primary', color: '#3b82f6', height: 'sm', action: { type: 'uri', label: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°', uri: `https://liff.line.me/${LIFF_ID}?action=joinGroup&id=${groupId}` } }
                        ]
                    }
                }
            };
            await liff.shareTargetPicker([message]);
        }

        async function handleShare() {
            if (!liff.isApiAvailable('shareTargetPicker')) return;
            const profile = await liff.getProfile();
            const balance = userData.summary?.balance || 0;
            let flexMessage;

            if (balance > 0) {
                flexMessage = {
                    type: 'flex', altText: `${profile.displayName} ‡∏≠‡∏ß‡∏î‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô!`,
                    contents: {
                        type: 'bubble', hero: { type: 'image', url: 'https://i.pinimg.com/736x/59/16/90/591690aa32490cf63a7abcabff3d85b6.jpg', size: 'full', aspectRatio: '20:13', aspectMode: 'cover' },
                        body: {
                            type: 'box', layout: 'vertical', spacing: 'md', contents: [
                                { type: 'text', text: '‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î‡πÑ‡∏õ‡πÄ‡∏•‡∏¢!', weight: 'bold', size: 'xl', color: '#10B981' },
                                {
                                    type: 'box', layout: 'vertical', margin: 'md', contents: [
                                        { type: 'text', text: `‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ ${profile.displayName} ‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ`, 'wrap': true, 'color': '#666666', 'size': 'sm', flex: 0 },
                                        { type: 'text', text: `${balance.toLocaleString('th-TH')} ‡∏ö‡∏≤‡∏ó!`, 'wrap': true, 'color': '#10B981', 'size': 'lg', 'weight': 'bold', 'margin': 'sm' }
                                    ]
                                },
                                { type: 'text', text: '‡∏°‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏±‡∏ö Wallet iton5 ‡∏Å‡∏±‡∏ô‡πÄ‡∏ñ‡∏≠‡∏∞', 'wrap': true, 'color': '#666666', 'size': 'sm', 'margin': 'md' }
                            ]
                        },
                        footer: {
                            type: 'box', layout: 'vertical', spacing: 'sm', contents: [
                                { type: 'button', style: 'primary', color: '#10B981', height: 'sm', action: { type: 'uri', label: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏ö‡πâ‡∏≤‡∏á', uri: `https://line.me/R/ti/p/@818vujfa` } }
                            ]
                        }
                    }
                };
            } else {
                flexMessage = {
                    type: 'flex', altText: `${profile.displayName} ‡∏ä‡∏ß‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≤‡πÉ‡∏ä‡πâ Wallet iton5`,
                    contents: {
                        type: 'bubble', hero: { type: 'image', url: 'https://i.pinimg.com/736x/17/14/41/17144109291fc721707a51367db9020e.jpg', size: 'full', aspectRatio: '20:13', aspectMode: 'cover' },
                        body: {
                            type: 'box', layout: 'vertical', contents: [
                                { type: 'text', text: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ!', weight: 'bold', size: 'xl' },
                                { type: 'text', text: `${profile.displayName} ‡∏ä‡∏ß‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≤‡πÉ‡∏ä‡πâ Wallet Bot ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ ‡πÅ‡∏•‡∏∞‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡∏ú‡πà‡∏≤‡∏ô LINE`, 'wrap': true, 'color': '#666666', 'size': 'sm', 'margin': 'md' }
                            ]
                        },
                        footer: {
                            type: 'box', layout: 'vertical', spacing: 'sm', contents: [
                                { type: 'button', style: 'primary', color: '#3b82f6', height: 'sm', action: { type: 'uri', label: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', uri: `https://line.me/R/ti/p/@818vujfa` } }
                            ]
                        }
                    }
                };
            }
            await liff.shareTargetPicker([flexMessage]);
        }

        async function handleViewGroupWallet(event) {
            const { groupId, groupName } = event.currentTarget.dataset;
            Swal.fire({ title: `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏∏‡πà‡∏° ${groupName}...`, didOpen: () => Swal.showLoading() });
            try {
                const profile = await liff.getProfile();
                const response = await fetch(`${API_URL}?action=getGroupWalletDetails&userId=${profile.userId}&groupId=${groupId}`);
                const result = await response.json();
                if (!result.success) throw new Error(result.error);

                const details = result.data;
                const settlementHtml = details.settlement.length > 0
                    ? details.settlement.map(s => `<p>${s.from} ‚û°Ô∏è ${s.to}|üü∞ ${s.amount.toLocaleString('th-TH', {
  minimumFractionDigits: 2,
  maximumFractionDigits: 2
})} ‡∏ö.</p>`).join('')
                    : '<p class="text-green-600 font-semibold">‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!</p>';

                const transactionsHtml = details.transactions.length > 0
                    ? details.transactions.map(tx => `
                        <div class="flex justify-between items-center py-1.5 border-b last:border-0">
                            <span class="text-gray-600">${tx.description}</span>
                            <span class="font-semibold">${tx.amount.toLocaleString()} ‡∏ö.</span>
                        </div>`).join('')
                    : '<p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ</p>';

                Swal.fire({
                    title: `‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏•‡∏∏‡πà‡∏°: ${groupName}`,
                    html: `
                        <div class="text-left space-y-4">
                            <div>
                                <h3 class="font-bold text-lg border-b pb-2 mb-2">‡πÉ‡∏Ñ‡∏£‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏Ñ‡∏£?</h3>
                                <div class="text-sm space-y-1">${settlementHtml}</div>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg border-b pb-2 mb-2">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å (${details.members.length} ‡∏Ñ‡∏ô)</h3>
                                <div class="text-sm text-gray-700">${details.members.map(m => m.displayName).join(', ')}</div>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg border-b pb-2 mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°</h3>
                                <div class="text-sm space-y-1 max-h-40 overflow-y-auto">${transactionsHtml}</div>
                            </div>
                        </div>
                    `,
                    confirmButtonText: '‡∏õ‡∏¥‡∏î'
                });
            } catch (error) {
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ: ${error.message}`, 'error');
            }
        }

        async function handleDeleteTransaction(event) {
            const button = event.currentTarget;
            const timestamp = button.dataset.timestamp;
            const profile = await liff.getProfile();
            event.stopPropagation();

            const result = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?', text: "‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ!", icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#6b7280',
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡πÄ‡∏•‡∏¢!', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            });

            if (result.isConfirmed) {
                Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...', didOpen: () => Swal.showLoading() });
                try {
                    const body = new URLSearchParams({ action: 'deleteTransaction', userId: profile.userId, timestamp });
                    const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body });
                    const resData = await response.json();
                    if (!resData.success) throw new Error(resData.error);

                    Swal.fire('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß', 'success');
                    await fetchAndRenderData(profile.userId);
                } catch (error) {
                    Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡πâ: ${error.message}`, 'error');
                }
            }
        }

        async function handleCreateChallenge() {
            const profile = await liff.getProfile();
            Swal.fire({
                title: '‡∏™‡∏£‡πâ‡∏≤‡∏á Challenge ‡πÉ‡∏´‡∏°‡πà',
                html: `
                      <div class="swal-custom-form space-y-4">
                        <div>
                            <label for="swal-challenge-name">‡∏ä‡∏∑‡πà‡∏≠ Challenge</label>
                            <input id="swal-challenge-name" class="swal-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô">
                        </div>
                        <div>
                            <label for="swal-challenge-amount">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)</label>
                            <input id="swal-challenge-amount" type="number" class="swal-input" placeholder="50000">
                        </div>
                        <div>
                            <label for="swal-challenge-date">‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                            <input id="swal-challenge-date" type="date" class="swal-input">
                        </div>
                    </div>
                `,
                confirmButtonText: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏ä‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô',
                focusConfirm: false,
                preConfirm: () => ({
                    name: document.getElementById('swal-challenge-name').value,
                    amount: document.getElementById('swal-challenge-amount').value,
                    endDate: document.getElementById('swal-challenge-date').value,
                })
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const formData = result.value;
                    if (!formData.name || !formData.amount || !formData.endDate) {
                        Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Challenge ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                        return;
                    }

                    Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Challenge...', didOpen: () => Swal.showLoading() });

                    try {
                        const body = new URLSearchParams({
                            action: 'createChallenge',
                            userId: profile.userId,
                            creatorName: profile.displayName,
                            name: formData.name,
                            amount: formData.amount,
                            endDate: formData.endDate
                        });
                        const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body });
                        const resData = await response.json();
                        if (!resData.success) throw new Error(resData.error);

                        await fetchAndRenderData(profile.userId);
                        Swal.close();

                        await shareChallenge(resData.data.challengeId, formData.name, formData.amount);

                    } catch (error) {
                        Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á Challenge ‡πÑ‡∏î‡πâ: ${error.message}`, 'error');
                    }
                }
            });
        }

        async function shareChallenge(challengeId, challengeName, challengeAmount) {
            if (!liff.isApiAvailable('shareTargetPicker')) return;
            const profile = await liff.getProfile();
            const message = {
                type: 'flex',
                altText: `${profile.displayName} ‡∏ó‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≤‡∏î‡∏ß‡∏•‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô!`,
                contents: {
                    type: 'bubble',
                    hero: { type: 'image', url: 'https://i.pinimg.com/736x/c9/42/94/c942947f0ce91f4d6db6ea017482fc37.jpg', size: 'full', aspectRatio: '20:13', aspectMode: 'cover' },
                    body: {
                        type: 'box', layout: 'vertical', spacing: 'md', contents: [
                            { type: 'text', text: '‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤‡∏î‡∏ß‡∏•‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô!', weight: 'bold', size: 'xl', color: '#F59E0B' },
                            { type: 'text', text: `"${challengeName}"`, weight: 'bold', size: 'lg', margin: 'md' },
                            { type: 'text', text: `‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ${parseInt(challengeAmount).toLocaleString()} ‡∏ö‡∏≤‡∏ó`, size: 'md', margin: 'sm' },
                            { type: 'text', text: `${profile.displayName} ‡∏ó‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≤‡πÅ‡∏Ç‡πà‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏∂‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢!`, 'wrap': true, 'color': '#666666', 'size': 'sm', 'margin': 'lg' }
                        ]
                    },
                    footer: {
                        type: 'box', layout: 'vertical', spacing: 'sm', contents: [
                            { type: 'button', style: 'primary', color: '#F59E0B', height: 'sm', action: { type: 'uri', label: '‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ó‡πâ‡∏≤!', uri: `https://liff.line.me/${LIFF_ID}?action=joinChallenge&id=${challengeId}` } }
                        ]
                    }
                }
            };
            await liff.shareTargetPicker([message]);
        }

        async function handleJoinChallenge(challengeId) {
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° Challenge...', didOpen: () => Swal.showLoading() });
            try {
                const profile = await liff.getProfile();
                const body = new URLSearchParams({
                    action: 'joinChallenge',
                    userId: profile.userId,
                    displayName: profile.displayName,
                    challengeId: challengeId
                });
                const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body });
                const resData = await response.json();
                if (!resData.success) throw new Error(resData.error);

                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', resData.data.message, 'success');
                window.history.replaceState({}, document.title, window.location.pathname);
                await fetchAndRenderData(profile.userId);

            } catch (error) {
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÑ‡∏î‡πâ: ${error.message}`, 'error');
            }
        }

        document.getElementById('addTransactionBtn').addEventListener('click', async () => {
            const profile = await liff.getProfile();
            const personalWallets = userData.wallets?.personal || [];
            const groupWallets = userData.wallets?.group || [];

            const walletOptionsHtml = [
                ...personalWallets.map(w => `<option value="${w.name}|personal">${w.name} (‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß)</option>`),
                ...groupWallets.map(w => `<option value="${w.name}|${w.groupId}">[‡∏Å‡∏•‡∏∏‡πà‡∏°] ${w.name}</option>`)
            ].join('');

            Swal.fire({
                title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà',
                html: `
                   <div class="swal-custom-form">
                        <div class="space-y-4">
                            <div>
                                <label for="swal-type">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                                <select id="swal-type" class="swal-select"><option value="‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢" selected>‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option><option value="‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option></select>
                            </div>
                            <div class="input-with-icon">
                                <label for="swal-description">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
                                <span class="icon"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path></svg></span>
                                <input id="swal-description" class="swal-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡πÅ‡∏ü, ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="input-with-icon">
                                    <label for="swal-amount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
                                     <span class="icon">‡∏ø</span>
                                    <input id="swal-amount" type="number" class="swal-input" placeholder="0.00">
                                </div>
                                <div class="input-with-icon">
                                    <label for="swal-category">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                                    <span class="icon"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h2zm0 0l-2.293-2.293a1 1 0 010-1.414l.001-.001a1 1 0 011.414 0L7 1.586zM7 15h.01M7 11h5a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2h2zm0 0l-2.293-2.293a1 1 0 010-1.414l.001-.001a1 1 0 011.414 0L7 9.586z"></path></svg></span>
                                    <input id="swal-category" class="swal-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏≤‡∏´‡∏≤‡∏£" >
                                </div>
                            </div>
                            <div>
                                <label for="swal-wallet">‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô</label>
                                <select id="swal-wallet" class="swal-select">${walletOptionsHtml || '<option value="‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î|personal">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î (‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß)</option>'}</select>
                            </div>
                        </div>
                    </div>
                `,
                confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                focusConfirm: false,
                preConfirm: () => {
                    const [walletName, groupIdOrType] = document.getElementById('swal-wallet').value.split('|');
                    return {
                        type: document.getElementById('swal-type').value,
                        description: document.getElementById('swal-description').value,
                        amount: document.getElementById('swal-amount').value,
                        category: document.getElementById('swal-category').value,
                        walletName: walletName,
                        groupId: groupIdOrType.startsWith('grp_') ? groupIdOrType : ''
                    }
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const formData = result.value;
                    if (!formData.description || !formData.amount || !formData.category) {
                        Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô', 'error');
                        return;
                    }
                    Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', didOpen: () => Swal.showLoading() });
                    try {
                        const body = new URLSearchParams({ action: 'addTransaction', userId: profile.userId, ...formData });
                        const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body });
                        const resData = await response.json();
                        if (!resData.success) throw new Error(resData.error);
                      
                        const Toast = Swal.mixin({
                        toast: true,
                        position: "top-end",
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true,
                        didOpen: (toast) => {
                            toast.onmouseenter = Swal.stopTimer;
                            toast.onmouseleave = Swal.resumeTimer;
                        }
                    });
                    Toast.fire({
                        icon: "success",
                        title: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß"
                    });


                        await fetchAndRenderData(profile.userId);
                    } catch (error) {
                        Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ${error.message}`, 'error');
                    }
                }
            });
        });
      
       const message = "‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡∏ß‡∏≤‡∏Ñ‡∏£‡∏±‡∏ö";

  document.addEventListener("contextmenu", function (e) {
    Swal.fire('Oh!', message, 'error');
   
    e.preventDefault();
  });

  document.addEventListener("mousedown", function (e) {
    if (e.button === 2 || e.button === 1) {
      Swal.fire('Oh!', message, 'error');
    
      e.preventDefault();
    }
  });

    </script>
</body>

</html>
