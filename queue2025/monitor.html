<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor - คิวปัจจุบัน</title>
    <meta name="description" content="Monitor NextQ LINE for MINI App" />
    <meta name="author" content="T42" />
    <meta property="og:title" content="Monitor NextQ LINE-T42-thailand" />
    <meta property="og:description" content="Monitor NextQ LINE for MINI App" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://wusxtldmqsleacfcibum.supabase.co/storage/v1/object/public/user-images/U69f69a6d9b1bbb632a0ff7db6e67eeac/1761888221050.jpeg" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --color-bg-dark: #3f334d;
            --color-bg-mid: #574b60;
            --color-text-light: #c0c5c1;
            --color-accent: #eaf0ce;
            --font-main: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        html, body {
            height: 100%;
            overflow: hidden;
            background: linear-gradient(135deg, var(--color-bg-dark), var(--color-bg-mid));
            font-family: var(--font-main);
            color: var(--color-text-light);
        }
        
        .main-layout {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        @media (min-width: 768px) { /* md */
            .main-layout {
                flex-direction: row;
            }
        }

        #banner-section {
            width: 100%;
            height: 40%; 
            overflow: hidden;
            position: relative;
            background-color: var(--color-bg-dark);
        }
        @media (min-width: 768px) {
            #banner-section {
                width: 50%; 
                height: 100%;
            }
        }
        #banner-slider {
            display: flex;
            height: 100%;
            transition: transform 1s ease-in-out;
        }
        .banner-slide {
            width: 100%;
            height: 100%;
            flex-shrink: 0;
            object-fit: cover;
        }

      
        #queue-section {
            width: 100%;
            height: 60%; 
            display: flex;
            flex-direction: column;
        }
        @media (min-width: 768px) {
            #queue-section {
                width: 50%;
                height: 100%;
            }
        }
        

        #current-serving-box {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            background-color: rgba(0,0,0,0.1);
            padding: 1rem;
        }
        #current-serving-title {
            font-size: 2rem; 
            font-weight: 600;
            color: var(--color-text-light);
            margin-bottom: 0.5rem;
        }
        #current-serving-number {
            font-size: 8rem; 
            font-weight: 900;
            color: var(--color-accent);
            line-height: 1;
            min-height: 1em; 
            transition: all 0.3s ease;
        }
        @media (min-width: 768px) {
            #current-serving-title { font-size: 2.5rem; } 
            #current-serving-number { font-size: 10rem; } 
        }
        @media (max-width: 380px) { 
            #current-serving-title { font-size: 1.5rem; }
            #current-serving-number { font-size: 6rem; }
        }

        
        #waiting-list-box {
            height: 40%; 
            min-height: 180px;
            background-color: rgba(0,0,0,0.3);
            padding: 1rem 1.5rem;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        @media (min-width: 768px) {
            #waiting-list-box {
                height: 40%; 
            }
        }
        #waiting-list-title {
            font-size: 1.25rem; 
            font-weight: 700;
            color: var(--color-text-light);
            margin-bottom: 0.75rem;
            flex-shrink: 0;
        }
        #waiting-list {
            flex-grow: 1;
            overflow-y: hidden; 
            display: flex;
            flex-direction: column;
            gap: 0.5rem; 
        }
        .waiting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.05);
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .waiting-item-number {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--color-accent);
        }
        .waiting-item-name {
            font-size: 1rem;
            color: var(--color-text-light);
           
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
        }

       
        #status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 0.75rem 1rem;
            background-color: rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            color: var(--color-text-light);
            z-index: 10;
        }
        #connection-status {
            display: flex;
            align-items: center;
            font-size: 0.875rem;
        }
        #connection-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.5rem;
            background-color: #f87171; 
            transition: background-color 0.5s ease;
        }
        #connection-dot.connected {
            background-color: #34d399; 
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(52, 211, 153, 0.7); }
            50% { box-shadow: 0 0 0 8px rgba(52, 211, 153, 0); }
        }
    </style>
</head>
<body>

    <div class="main-layout">
      
        <section id="banner-section">
              <div id="banner-slider">
              
                <img class="banner-slide" src="" alt=https://cdn.pixabay.com/photo/2019/07/13/11/44/coffee-4334647_1280.jpgPromotion 1" loading="lazy">
                <img class="banner-slide" src="https://cdn.pixabay.com/photo/2015/06/11/07/31/latte-805538_1280.jpg" alt="New Menu" loading="lazy">
                <img class="banner-slide" src="https://cdn.pixabay.com/photo/2015/07/16/16/48/sweets-847920_1280.jpg" alt="Open Everyday" loading="lazy">
            </div>
        </section>

        <section id="queue-section">
            
            <div id="current-serving-box">
                <h1 id="current-serving-title">คิวที่กำลังให้บริการ</h1>
                <div id="current-serving-number" aria-live="polite">...</div>
            </div>

            <div id="waiting-list-box">
                <h2 id="waiting-list-title">คิวรอถัดไป 5 ลำดับ</h2>
                <div id="waiting-list">
                   
                </div>
            </div>

        </section>

    </div>
    
   
    <div id="status-bar">
        <div id="connection-status">
            <div id="connection-dot"></div>
            <span id="connection-text">กำลังเชื่อมต่อ...</span>
        </div>
    </div>

    <script type="module">
       
        const SUPABASE_URL = "https://wusxtldmqsleacfcibum.supabase.co";
       
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind1c3h0bGRtcXNsZWFjZmNpYnVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyOTE5NTEsImV4cCI6MjA2OTg2Nzk1MX0.qiChtXkvDonyePfsP3MSpsizcm1708RFazGTZqtUZ8I";
        const POLLING_INTERVAL_MS = 3000; 

       
        const currentServingNumberEl = document.getElementById('current-serving-number');
        const waitingListEl = document.getElementById('waiting-list');
        const connectionDot = document.getElementById('connection-dot');
        const connectionText = document.getElementById('connection-text');
        const bannerSlider = document.getElementById('banner-slider');
        
        let supabase;
        let bannerSlides = [];
        let currentSlideIndex = 0;

        
        function updateServingNumber(number) {
            const numStr = number || "0";
            if (currentServingNumberEl.textContent !== numStr) {
                currentServingNumberEl.style.transform = 'scale(0.9)';
                currentServingNumberEl.style.opacity = '0.5';
                setTimeout(() => {
                    currentServingNumberEl.textContent = numStr;
                    currentServingNumberEl.style.transform = 'scale(1)';
                    currentServingNumberEl.style.opacity = '1';
                }, 150);
            }
        }
        
      
        function updateWaitingList(queues = []) {
            waitingListEl.innerHTML = ''; 
            if (queues.length === 0) {
                waitingListEl.innerHTML = `<p class="text-gray-400 text-center">ไม่มีคิวรอ</p>`;
                return;
            }
            
            queues.forEach(q => {
                const item = document.createElement('div');
                item.className = 'waiting-item';
           
                const displayName = q.display_name.length > 15 ? q.display_name.substring(0, 15) + '...' : q.display_name;
                
                item.innerHTML = `
                    <span class="waiting-item-number">Q. ${q.queue_number}</span>
                    <span class="waiting-item-name">${displayName}</span>
                `;
                waitingListEl.appendChild(item);
            });
        }
        
        function setConnectionStatus(status) {
             if (status === 'CONNECTED') {
                connectionDot.classList.add('connected');
                connectionText.textContent = 'เชื่อมต่อ (Polling)';
             } else if (status === 'ERROR') {
                connectionDot.classList.remove('connected');
                connectionDot.style.backgroundColor = '#f87171'; // Red
                connectionText.textContent = 'ตัดการเชื่อมต่อ';
             }
        }

       
        function getTodayUTCRange() {
            const today = new Date();
            const year = today.getUTCFullYear();
            const month = (today.getUTCMonth() + 1).toString().padStart(2, '0');
            const day = today.getUTCDate().toString().padStart(2, '0');
            
            const dateString = `${year}-${month}-${day}`;
            
            return {
                start: `${dateString}T00:00:00.000Z`,
                end: `${dateString}T23:59:59.999Z`
            };
        }

        async function fetchCurrentData() {
            if (!supabase) return;

            try {
                const { start, end } = getTodayUTCRange();
                
                
                const p1 = supabase
                    .from('queue_service_status')
                    .select('current_serving_number')
                    .eq('id', 1)
                    .single();
                
              
                const p2 = supabase
                    .from('queues')
                    .select('queue_number, display_name')
                    .eq('status', 'WAITING')
                    .gte('created_at', start)
                    .lte('created_at', end)
                    .order('queue_number', { ascending: true })
                    .limit(5);

             
                const [statusResult, waitingResult] = await Promise.all([p1, p2]);

         
                if (statusResult.error) throw statusResult.error;
                if (waitingResult.error) throw waitingResult.error;
                
               
                updateServingNumber(statusResult.data.current_serving_number);
                updateWaitingList(waitingResult.data);
                
                setConnectionStatus('CONNECTED'); 
                
            } catch (error) {
                console.error('Polling Error:', error);
                setConnectionStatus('ERROR'); 
            }
        }
        
       
        function startBannerSlider() {
            bannerSlides = bannerSlider.children;
            if (bannerSlides.length <= 1) return; 

            setInterval(() => {
                currentSlideIndex = (currentSlideIndex + 1) % bannerSlides.length;
                bannerSlider.style.transform = `translateX(-${currentSlideIndex * 100}%)`;
            }, 5000); 
        }

     
        async function initialize() {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                
              
                await fetchCurrentData(); 
                setConnectionStatus('CONNECTED'); 

              
                setInterval(fetchCurrentData, POLLING_INTERVAL_MS);
                
                
                startBannerSlider();

            } catch (error) {
                console.error('Monitor Init Error:', error);
                currentServingNumberEl.textContent = "Error";
                setConnectionStatus('ERROR');
            }
        }

        window.addEventListener('load', initialize);
    </script>

</body>
</html>
